@using Sidekick.Common.Settings
@using System.Globalization
@using Microsoft.Extensions.Localization
@using Sidekick.Apis.Poe.Languages
@using Sidekick.Common.Ui.Forms

<FormSelect Label="@Resources["Language_Parser"]"
            Value="@Language"
            ValueChanged="LanguageChanged"
            Options="Options" />

@inject IStringLocalizer<SettingsResources> Resources
@inject IGameLanguageProvider GameLanguageProvider
@inject ISettingsService SettingsService
@inject NavigationManager NavigationManager

@code {

    private string? Language { get; set; }

    private List<SelectOption> Options { get; set; } =
    [
    ];

    protected override async Task OnInitializedAsync()
    {
        Language = await SettingsService.GetString(SettingKeys.LanguageParser);
        var languages = GameLanguageProvider.GetList();
        Options = languages
                  .OrderBy(x => x.Label)
                  .Select(
                      x => new SelectOption()
                          {
                              Value = x.Code,
                              Label = $"{new CultureInfo(x.Code).DisplayName} ({x.Code})",
                          })
                  .ToList();

        await base.OnInitializedAsync();
    }

    private async Task LanguageChanged(string? value)
    {
        Language = value;
        await SettingsService.Set(SettingKeys.LanguageParser, value);
        // TODO: Clear data?
        NavigationManager.NavigateTo("/initialize");
    }

}


