@using Sidekick.Common.Platform
@using Sidekick.Common.Platform.EventArgs
@using Sidekick.Common.Ui.Views
@using Sidekick.Electron.Services
@using static ElectronNET.API.Electron;

<Sidekick.Common.Ui.Main />

@inject ICurrentView CurrentView
@inject ElectronViewLocator ViewLocator
@inject IKeyboardProvider KeyboardProvider
@inject IApplicationService ApplicationService
@implements IDisposable

@code {

    [Inject]
    public required NavigationManager NavigationManager { get; set; }

    protected override void OnInitialized()
    {
        ViewLocator.Views.Add(this);

        CurrentView.Minimized += CurrentViewMinimized;
        CurrentView.Maximized += CurrentViewMaximized;
        CurrentView.Closed += CurrentViewClosed;

        base.OnInitialized();
    }

    private void CurrentViewMinimized()
    {
        WindowManager.BrowserWindows.FirstOrDefault()?.Minimize();
    }

    private async void CurrentViewMaximized()
    {
        var browserWindow = WindowManager.BrowserWindows.FirstOrDefault();
        
        if (browserWindow == null)
        {
            return;
        }

        var isMaximized = await browserWindow.IsMaximizedAsync();

        if (isMaximized)
        {
            browserWindow.Unmaximize();
        }
        else
        {
            browserWindow.Maximize();
        }
    }

    private void CurrentViewClosed()
    {
        if (new Uri(NavigationManager.Uri).PathAndQuery == "/home")
        {
            App.Quit();
        }
        else
        {
            NavigationManager.NavigateTo("/home");
        }
    }

    public void Dispose()
    {
        ViewLocator.Views.Remove(this);
        CurrentView.Closed -= CurrentViewClosed;
    }

}
