@using Sidekick.Apis.Poe.Account.Authentication
@using Sidekick.Modules.Wealth.Localization

@if (CurrentState != AuthenticationState.Authenticated)
{
    <div class="flex flex-nowrap items-center justify-center gap-2">
        <div class="bg-red-500 rounded-full w-2 h-2"></div>
        <ButtonLink OnClick="() => AuthenticationService.Authenticate(true)"
                    Class="!text-red-600">
            @Resources["Unauthenticated"]
        </ButtonLink>
    </div>
}
else
{
    @ChildContent
}

@implements IDisposable
@inject IStringLocalizer<WealthResources> Resources
@inject IAuthenticationService AuthenticationService

@code {

    [Parameter]
    public RenderFragment? ChildContent { get; set; }

    private Timer? refreshTimer;

    private AuthenticationState CurrentState { get; set; }

    protected override void OnInitialized()
    {
        AuthenticationService.OnStateChanged += OnChanged;

        refreshTimer = new Timer(_ => { OnChanged(); }, null, TimeSpan.Zero, TimeSpan.FromMinutes(1));

        OnChanged();
        base.OnInitialized();
    }

    private void OnChanged()
    {
        InvokeAsync(async () =>
        {
            CurrentState = await AuthenticationService.GetCurrentState();
            StateHasChanged();
        });
    }

    public void Dispose()
    {
        refreshTimer?.Dispose();
        AuthenticationService.OnStateChanged -= OnChanged;
    }

}
