@using Sidekick.Apis.Poe.Items
@using Sidekick.Apis.Poe2Scout.History
@using Sidekick.Apis.Poe2Scout.History.Models
@using Sidekick.Apis.Poe2Scout.Items
@using Sidekick.Apis.Poe2Scout.Items.Models
@using Sidekick.Apis.PoeNinja.Exchange
@using Sidekick.Apis.PoeNinja.Exchange.Models
@using Sidekick.Apis.PoeNinja.Items
@using Sidekick.Modules.Item.Exchange.Localization
@using Sidekick.Modules.Item.PoeNinja
@using Sidekick.Modules.Item.PoeNinja.Localization

@if (Loading)
{
    <AppLoading/>
    return;
}

@if (ScoutHistory == null && NinjaCurrency == null)
{
    <AlertInfo Flat="true">@Resources["NoCurrencyExchangeData"]</AlertInfo>
}

@if (NinjaCurrency != null)
{
    <PoeNinjaWebsite LastUpdated="NinjaCurrency.LastUpdated" DetailsUrl="NinjaCurrency.DetailsUrl"/>
    <PoeNinjaCurrencyPanel Currency="NinjaCurrency"/>
}

@if (ScoutHistory != null && NinjaCurrency != null)
{
    <LayoutDivider/>
}

@if (ScoutHistory != null)
{
    <Poe2ScoutWebsite History="ScoutHistory" Item="ScoutItem"/>
    <Poe2ScoutPanel Currency="exalted" Logs="@ScoutHistory.Exalted" QuantityLabel="@PoeNinjaResources["VolumeTraded"]"/>
    <Poe2ScoutPanel Currency="chaos" Logs="@ScoutHistory.Chaos" QuantityLabel="@PoeNinjaResources["VolumeTraded"]"/>
    <Poe2ScoutPanel Currency="divine" Logs="@ScoutHistory.Divine" QuantityLabel="@PoeNinjaResources["VolumeTraded"]"/>
}

@inject IScoutHistoryProvider ScoutHistoryProvider
@inject IScoutItemProvider ScoutItemProvider
@inject INinjaExchangeProvider NinjaExchangeProvider
@inject INinjaItemProvider NinjaItemProvider
@inject IStringLocalizer<ExchangeResources> Resources
@inject IStringLocalizer<PoeNinjaResources> PoeNinjaResources

@code {

    [CascadingParameter]
    public required Item Item { get; set; }

    private ScoutHistory? ScoutHistory { get; set; }

    private ScoutItem? ScoutItem { get; set; }

    private NinjaCurrency? NinjaCurrency { get; set; }

    private bool Loading { get; set; }

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();

        Loading = true;
        StateHasChanged();

        await Task.WhenAll(LoadScout(), LoadNinja());

        Loading = false;
        StateHasChanged();
    }

    private async Task LoadScout()
    {
        ScoutItem = await ScoutItemProvider.GetItem(Item.ApiInformation.InvariantText);
        ScoutHistory = (ScoutItem != null) ? await ScoutHistoryProvider.GetCurrencyHistory(ScoutItem.ItemId) : null;
    }

    private async Task LoadNinja()
    {
        var item = NinjaItemProvider.GetExchangeItem(Item.ApiInformation.InvariantId);
        NinjaCurrency = item != null ? await NinjaExchangeProvider.GetInfo(item) : null;
    }

}
