@using Sidekick.Apis.Poe.Items
@using Sidekick.Apis.Poe2Scout.History
@using Sidekick.Apis.Poe2Scout.History.Models
@using Sidekick.Apis.Poe2Scout.Items
@using Sidekick.Apis.Poe2Scout.Items.Models
@using Sidekick.Apis.PoeNinja.Stash
@using Sidekick.Apis.PoeNinja.Stash.Models
@using Sidekick.Modules.Trade.Poe2Scout
@using Sidekick.Modules.Trade.PoeNinja
@using Sidekick.Modules.Trade.Unique.Localization

@if (Loading)
{
    <AppLoading/>
    return;
}

@if (ScoutHistory == null && NinjaStash == null)
{
    <AlertInfo Flat="true">@Resources["NoData"]</AlertInfo>
}

@if (NinjaStash != null)
{
    <PoeNinjaWebsite LastUpdated="NinjaStash.LastUpdated" DetailsUrl="NinjaStash.DetailsUrl"/>
    <PoeNinjaStashPanel Stash="NinjaStash"/>
}

@if (ScoutHistory != null && NinjaStash != null)
{
    <LayoutDivider/>
}

@if (ScoutHistory != null)
{
    <Poe2ScoutWebsite History="ScoutHistory"/>
    <Poe2ScoutPanel Currency="exalted" Logs="@ScoutHistory.Exalted" QuantityLabel=""/>
    <Poe2ScoutPanel Currency="chaos" Logs="@ScoutHistory.Chaos"/>
    <Poe2ScoutPanel Currency="divine" Logs="@ScoutHistory.Divine"/>
}

@inject IScoutHistoryProvider ScoutHistoryProvider
@inject IScoutItemProvider ScoutItemProvider
@inject INinjaStashProvider NinjaStashProvider
@inject IStringLocalizer<UniqueResources> Resources

@code {

    [CascadingParameter]
    public required Item Item { get; set; }

    private ScoutHistory? ScoutHistory { get; set; }

    private ScoutItem? ScoutItem { get; set; }

    private NinjaStash? NinjaStash { get; set; }

    private bool Loading { get; set; }

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();

        Loading = true;
        StateHasChanged();

        await Task.WhenAll(LoadScout(), LoadNinja());

        Loading = false;
        StateHasChanged();
    }

    private async Task LoadScout()
    {
        ScoutItem = await ScoutItemProvider.GetItem(Item.ApiInformation.InvariantName);
        if (ScoutItem != null)
        {
            ScoutHistory = await ScoutHistoryProvider.GetItemHistory(ScoutItem.ItemId);
        }
    }

    private async Task LoadNinja()
    {
        NinjaStash = await NinjaStashProvider.GetUniqueInfo(Item.ApiInformation.InvariantName, Item.Properties.GetMaximumNumberOfLinks());
    }

}
