@using Sidekick.Apis.Poe.Items
@using Sidekick.Apis.PoeNinja.Stash
@using Sidekick.Modules.Trade.BaseType.Localization
@using Sidekick.Common.Ui.Tabs

@if (Valid)
{
    <TabItem Active="@(CurrentTab == "basetype")"
             Text="@Resources["BaseType"]"
             OnClick="@(() => CurrentTabChanged.InvokeAsync("basetype"))"/>
}

@inject IStringLocalizer<BaseTypeResources> Resources
@inject INinjaStashProvider NinjaStashProvider

@code {

    [CascadingParameter]
    public required Item Item { get; set; }

    [Parameter]
    public string? CurrentTab { get; set; }

    [Parameter]
    public EventCallback<string?> CurrentTabChanged { get; set; }

    private bool Valid { get; set; }

    protected override async Task OnInitializedAsync()
    {
        if (Item.Properties.Rarity != Rarity.Unique)
        {
            List<Task<bool>> tasks =
            [
                CheckNinja(),
            ];

            var result = await Task.WhenAll(tasks);
            Valid = result.Any(x => x);
            if (Valid) await CurrentTabChanged.InvokeAsync("basetype");
        }

        await base.OnInitializedAsync();
    }

    private async Task<bool> CheckNinja()
    {
        return await NinjaStashProvider.GetInfo(Item) != null;
    }

}