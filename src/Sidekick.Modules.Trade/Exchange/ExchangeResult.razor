@using Sidekick.Apis.Poe.Items
@using Sidekick.Apis.Poe2Scout.History
@using Sidekick.Apis.Poe2Scout.History.Models
@using Sidekick.Apis.Poe2Scout.Items
@using Sidekick.Apis.Poe2Scout.Items.Models
@using Sidekick.Modules.Trade.Exchange.Localization
@using Sidekick.Modules.Trade.Poe2Scout

@if (Loading)
{
    <AppLoading/>
    return;
}

@if (ScoutHistory == null)
{
    <AlertInfo Flat="true">@Resources["NoCurrencyExchangeData"]</AlertInfo>
}
else if (ScoutHistory != null)
{
    <Poe2ScoutWebsite History="ScoutHistory" Item="ScoutItem"/>
    <Poe2ScoutPanel Currency="exalted" Logs="@ScoutHistory.Exalted" QuantityLabel="@Resources["VolumeTraded"]"/>
    <Poe2ScoutPanel Currency="chaos" Logs="@ScoutHistory.Chaos" QuantityLabel="@Resources["VolumeTraded"]"/>
    <Poe2ScoutPanel Currency="divine" Logs="@ScoutHistory.Divine" QuantityLabel="@Resources["VolumeTraded"]"/>
}

@inject IScoutHistoryProvider ScoutHistoryProvider
@inject IScoutItemProvider ScoutItemProvider
@inject IStringLocalizer<ExchangeResources> Resources

@code {

    [CascadingParameter]
    public required Item Item { get; set; }

    private ScoutHistory? ScoutHistory { get; set; }

    private ScoutItem? ScoutItem { get; set; }

    private bool Loading { get; set; }

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();

        Loading = true;
        StateHasChanged();

        ScoutItem = await ScoutItemProvider.GetItem(Item.ApiInformation.InvariantText);
        if (ScoutItem != null)
        {
            ScoutHistory = await ScoutHistoryProvider.GetCurrencyHistory(ScoutItem.ItemId);
        }

        Loading = false;
        StateHasChanged();
    }

}
