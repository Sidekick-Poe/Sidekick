@using Sidekick.Apis.Poe.Items
@using Sidekick.Apis.Poe2Scout.Items
@using Sidekick.Apis.PoeNinja.Items
@using Sidekick.Modules.Trade.Exchange.Localization
@using Sidekick.Common.Ui.Tabs

@if (SupportsCurrencyExchange)
{
    <TabItem Active="@(CurrentTab == "exchange")"
             Text="@Resources["CurrencyExchange"]"
             OnClick="@(() => CurrentTabChanged.InvokeAsync("exchange"))"/>
}

@inject IStringLocalizer<ExchangeResources> Resources
@inject IScoutItemProvider ScoutItemProvider
@inject INinjaItemProvider NinjaItemProvider

@code {

    [CascadingParameter]
    public required Item Item { get; set; }

    [Parameter]
    public string? CurrentTab { get; set; }

    [Parameter]
    public EventCallback<string?> CurrentTabChanged { get; set; }

    private bool SupportsCurrencyExchange { get; set; }

    protected override async Task OnInitializedAsync()
    {
        List<Task<bool>> tasks =
        [
            CheckNinja(),
            CheckScout(),
        ];

        var result = await Task.WhenAll(tasks);
        SupportsCurrencyExchange = result.Any(x => x);
        if (SupportsCurrencyExchange) await CurrentTabChanged.InvokeAsync("exchange");

        await base.OnInitializedAsync();
    }

    private Task<bool> CheckNinja()
    {
        var ninjaPage = NinjaItemProvider.GetPage(Item.ApiInformation.InvariantId);
        return Task.FromResult(ninjaPage?.SupportsExchange ?? false);
    }

    private async Task<bool> CheckScout()
    {
        var scoutItem = await ScoutItemProvider.GetItem(Item.ApiInformation.InvariantText);
        return scoutItem?.IsCurrency ?? false;
    }

}