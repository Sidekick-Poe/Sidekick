@using Sidekick.Apis.Poe.Items
@using Sidekick.Apis.PoeNinja.Items
@using Sidekick.Apis.PoeNinja.Stash
@using Sidekick.Apis.PoeNinja.Stash.Models
@using Sidekick.Modules.Trade.PoeNinja
@using Sidekick.Modules.Trade.PoePrices
@using Sidekick.Modules.Trade.Unique.Localization

@if (Loading)
{
    <AppLoading/>
    return;
}

@if (NinjaStash == null)
{
    <AlertInfo Flat="true">@Resources["NoData"]</AlertInfo>
}

@if (NinjaStash != null)
{
    <PoeNinjaWebsite LastUpdated="NinjaStash.LastUpdated" DetailsUrl="NinjaStash.DetailsUrl"/>

    @if (Item.Properties.Rarity != Rarity.Unique)
    {
        <TextCaption>Poe.ninja only looks at specific information about the item to provide a price. The base type, item
            level and influences are what poe.ninja currently looks for.
        </TextCaption>
    }

    <PoeNinjaStashPanel Stash="NinjaStash"/>
}

<SidekickErrorBoundary>
    <PricePredictionComponent/>
</SidekickErrorBoundary>

@inject INinjaStashProvider NinjaStashProvider
@inject INinjaItemProvider NinjaItemProvider
@inject IStringLocalizer<UniqueResources> Resources

@code {

    [CascadingParameter]
    public required Item Item { get; set; }

    private NinjaStash? NinjaStash { get; set; }

    private bool Loading { get; set; }

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();

        Loading = true;
        StateHasChanged();

        var item = NinjaItemProvider.GetStashItem(Item);
        NinjaStash = item != null ? await NinjaStashProvider.GetInfo(item) : null;

        Loading = false;
        StateHasChanged();
    }
}
