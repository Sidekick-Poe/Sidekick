@page "/item/{itemText}"
@using Sidekick.Apis.Poe.Items
@using Sidekick.Apis.Poe.Trade.Clients
@using Sidekick.Apis.Poe.Trade.Parser
@using Sidekick.Common.Extensions
@using Sidekick.Common.Settings
@using Sidekick.Common.Ui.Api
@using Sidekick.Common.Ui.Tabs
@using Sidekick.Modules.Items.AreaInformation
@using Sidekick.Modules.Items.Components
@using Sidekick.Modules.Items.Exchange
@using Sidekick.Modules.Items.Tools
@using Sidekick.Modules.Items.Tools.Chromatic
@using Sidekick.Modules.Items.Trade.Filters
@using Sidekick.Modules.Items.Valuation
@using Sidekick.Modules.Items.Wiki
@using Sidekick.Modules.Items.Trade

<LayoutTwoColumn LeftContentWidth="@LeftContentWidth" OnLeftContentResize="@OnLeftContentResize">
    <TopContent>
        <AppBar>
            <AppSettings Href="/settings/game"/>
            <AppClose/>
        </AppBar>
    </TopContent>
    <LeftContent>
        @if (Item != null)
        {
            <CascadingValue Value="Item"
                            IsFixed="true">
                <FiltersComponent/>
            </CascadingValue>
        }
    </LeftContent>
    <ChildContent>
        @if (Item != null)
        {
            <CascadingValue Value="Item"
                            IsFixed="true">
                <AppContainer>
                    <div class="sticky top-0 z-10 pb-1 mb-2 -mt-3 pt-2 bg-stone-900">
                        <TabList>
                            <ChildContent>
                                <AreaTab CurrentTab="@CurrentTab" CurrentTabChanged="TabChanged"/>
                                <ExchangeTab CurrentTab="@CurrentTab" CurrentTabChanged="TabChanged"/>
                                <ValuationTab CurrentTab="@CurrentTab" CurrentTabChanged="TabChanged"/>
                                <TradeTab CurrentTab="@CurrentTab" CurrentTabChanged="TabChanged"/>
                                <ToolTab CurrentTab="@CurrentTab" CurrentTabChanged="TabChanged"/>
                                <WikiTab/>
                            </ChildContent>
                            <RightContent>
                                <LeagueText/>
                            </RightContent>
                        </TabList>

                        @switch (CurrentTab)
                        {
                            case "trade":
                                <TradeSticky/> break;
                        }
                    </div>

                    @switch (CurrentTab)
                    {
                        case "area":
                            <AreaResult/> break;
                        case "trade":
                            <TradeResult/> break;
                        case "exchange":
                            <ExchangeResult/> break;
                        case "valuation":
                            <ValuationResult/> break;
                        case "chromatic":
                            <ChromaticCalculator/> break;
                    }
                </AppContainer>
            </CascadingValue>
        }
    </ChildContent>
    <BottomContent>
        <div class="px-2 py-0.5 border-t border-stone-700 flex justify-end">
            <ApiStatusAndLimits ApiClientName="@TradeApiClient.ClientName"/>
        </div>
    </BottomContent>
</LayoutTwoColumn>

@inject ISettingsService SettingsService
@inject TradeService TradeService
@inject IItemParser ItemParser

@code {

    [Parameter]
    public required string ItemText { get; set; }

    private int LeftContentWidth { get; set; }

    private Item? Item { get; set; }

    private string? CurrentTab { get; set; } = "trade";

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        LeftContentWidth = await SettingsService.GetInt(SettingKeys.PriceCheckSidebarWidth);
    }

    protected override async Task OnParametersSetAsync()
    {
        if (Item != null)
        {
            Item = null;
            StateHasChanged();
            await Task.Delay(100);
        }

        TradeService.Init();
        var itemText = ItemText.DecodeBase64Url();
        Item = ItemParser.ParseItem(itemText);

        await base.OnParametersSetAsync();
    }

    private async Task TabChanged(string? tab)
    {
        await InvokeAsync(() =>
        {
            CurrentTab = tab ?? "trade";
            StateHasChanged();
        });
    }

    private async Task OnLeftContentResize(int width)
    {
        await SettingsService.Set(SettingKeys.PriceCheckSidebarWidth, width);
    }

}
