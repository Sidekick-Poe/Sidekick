@using Sidekick.Apis.Poe.Items
@using Sidekick.Apis.PoePriceInfo
@using Sidekick.Apis.PoePriceInfo.Models
@using Sidekick.Common.Settings
@using Sidekick.Modules.Items.PoePrices

@if (Loading)
{
    <AppLoading Label="PoePrices.info"/>
    return;
}

@if (Prediction == null)
{
    return;
}

<PricePredictionComponent Min="Prediction.Min"
                          Max="Prediction.Max"
                          Currency="@Prediction.Currency"
                          Confidence="Prediction.ConfidenceScore"/>

@inject IPoePriceInfoClient Client
@inject ISettingsService SettingsService

@code {

    [CascadingParameter]
    public required Item Item { get; set; }

    [Parameter]
    public EventCallback<bool> AfterInitialized { get; set; }

    private PricePrediction? Prediction { get; set; }

    private bool Loading { get; set; }

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();

        if (!await SettingsService.GetBool(SettingKeys.PriceCheckPredictionEnabled))
        {
            await AfterInitialized.InvokeAsync(false);
            return;
        }

        Loading = true;
        StateHasChanged();

        Prediction = await Client.GetPricePrediction(Item);

        Loading = false;
        StateHasChanged();

        await AfterInitialized.InvokeAsync(Prediction != null);
    }
}