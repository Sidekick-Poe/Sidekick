@using System.Text.Json
@using Sidekick.Apis.Poe.Items
@using Sidekick.Apis.Poe.Languages
@using Sidekick.Apis.Poe.Trade.Trade.Filters.AutoSelect

@if (Condition.Comparison is AutoSelectComparisonType.True or AutoSelectComparisonType.False)
{
    return;
}

@if (Condition.Comparison is AutoSelectComparisonType.IsContainedIn or AutoSelectComparisonType.IsNotContainedIn)
{
    <div class="grid grid-cols-3 gap-y-0.5 gap-x-3 w-full">
        @foreach (var option in GetOptions())
        {
            <FormCheckbox Value="IsChecked(option)"
                          ValueChanged="(value) => ToggleCheck(option, value)"
                          Readonly="Readonly">
                <span class="line-clamp-1">@option.Label</span>
            </FormCheckbox>
        }
    </div>
    return;
}

<FormInputInline Value="@Condition.Value"
                 ValueChanged="Changed"
                 Readonly="Readonly"/>

@inject IGameLanguageProvider GameLanguageProvider
@inject IStringLocalizer<StatCategory> StatCategoryResources

@code {

    [CascadingParameter]
    public required Item Item { get; set; }

    [Parameter]
    public required AutoSelectCondition Condition { get; set; }

    [Parameter]
    public bool Readonly { get; set; }

    [Parameter]
    public EventCallback OnChanged { get; set; }

    public void Update()
    {
        StateHasChanged();
    }

    private async Task Changed(string? value)
    {
        Condition.Value = value;
        await OnChanged.InvokeAsync();
    }

    private bool IsChecked(SelectOption option) => Condition.Value?.Contains($"\"{option.Value ?? "null"}\"") ?? false;

    private async Task ToggleCheck(SelectOption option, bool isChecked)
    {
        List<string> value;
        try
        {
            value = JsonSerializer.Deserialize<List<string>>(Condition.Value ?? "[]", AutoSelectPreferences.JsonSerializerOptions) ?? [];
        }
        catch (Exception)
        {
            value = [];
        }

        if (isChecked)
        {
            value.Add(option.Value ?? "null");
        }
        else
        {
            value.Remove(option.Value ?? "null");
        }

        Condition.Value = JsonSerializer.Serialize(value, AutoSelectPreferences.JsonSerializerOptions);
        await OnChanged.InvokeAsync();
    }

    private List<SelectOption> GetOptions()
    {
        if (Condition.Type == AutoSelectConditionType.Rarity)
        {
            return
            [
                CreateRarity(Rarity.Normal),
                CreateRarity(Rarity.Magic),
                CreateRarity(Rarity.Rare),
                CreateRarity(Rarity.Unique),
                CreateRarity(Rarity.Currency),
            ];

            SelectOption CreateRarity(Rarity rarity)
            {
                return new SelectOption()
                {
                    Label = rarity switch
                    {
                        Rarity.Currency => GameLanguageProvider.Language.RarityCurrency,
                        Rarity.DivinationCard => GameLanguageProvider.Language.RarityDivinationCard,
                        Rarity.Normal => GameLanguageProvider.Language.RarityNormal,
                        Rarity.Magic => GameLanguageProvider.Language.RarityMagic,
                        Rarity.Rare => GameLanguageProvider.Language.RarityRare,
                        Rarity.Unique => GameLanguageProvider.Language.RarityUnique,
                        _ => rarity.ToString(),
                    },
                    Value = rarity.ToString(),
                };
            }
        }

        if (Condition.Type == AutoSelectConditionType.ItemClass)
        {
            return
            [
                CreateItemClass(ItemClass.AbyssJewel),
                CreateItemClass(ItemClass.Amulet),
                CreateItemClass(ItemClass.Belt),
                CreateItemClass(ItemClass.BodyArmour),
                CreateItemClass(ItemClass.Boots),
                CreateItemClass(ItemClass.Bow),
                CreateItemClass(ItemClass.Claw),
                CreateItemClass(ItemClass.Crossbow),
                CreateItemClass(ItemClass.Dagger),
                CreateItemClass(ItemClass.FishingRod),
                CreateItemClass(ItemClass.Flask),
                CreateItemClass(ItemClass.Gloves),
                CreateItemClass(ItemClass.Helmet),
                CreateItemClass(ItemClass.Jewel),
                CreateItemClass(ItemClass.OneHandAxe),
                CreateItemClass(ItemClass.OneHandMace),
                CreateItemClass(ItemClass.OneHandSword),
                CreateItemClass(ItemClass.Quiver),
                CreateItemClass(ItemClass.Ring),
                CreateItemClass(ItemClass.RuneDagger),
                CreateItemClass(ItemClass.Sceptre),
                CreateItemClass(ItemClass.Shield),
                CreateItemClass(ItemClass.Staff),
                CreateItemClass(ItemClass.TwoHandAxe),
                CreateItemClass(ItemClass.TwoHandMace),
                CreateItemClass(ItemClass.TwoHandSword),
                CreateItemClass(ItemClass.Wand),
                CreateItemClass(ItemClass.Warstaff),
            ];

            SelectOption CreateItemClass(ItemClass itemClass)
            {
                return new SelectOption()
                {
                    Label = itemClass switch
                    {
                        ItemClass.AbyssJewel => GameLanguageProvider.Language.Classes.AbyssJewel,
                        ItemClass.Amulet => GameLanguageProvider.Language.Classes.Amulet,
                        ItemClass.Belt => GameLanguageProvider.Language.Classes.Belt,
                        ItemClass.BodyArmour => GameLanguageProvider.Language.Classes.BodyArmours,
                        ItemClass.Boots => GameLanguageProvider.Language.Classes.Boots,
                        ItemClass.Bow => GameLanguageProvider.Language.Classes.Bows,
                        ItemClass.Claw => GameLanguageProvider.Language.Classes.Claws,
                        ItemClass.Crossbow => GameLanguageProvider.Language.Classes.Crossbows,
                        ItemClass.Dagger => GameLanguageProvider.Language.Classes.Daggers,
                        ItemClass.FishingRod => GameLanguageProvider.Language.Classes.FishingRods,
                        ItemClass.Flask => GameLanguageProvider.Language.Classes.UtilityFlasks,
                        ItemClass.Gloves => GameLanguageProvider.Language.Classes.Gloves,
                        ItemClass.Helmet => GameLanguageProvider.Language.Classes.Helmets,
                        ItemClass.Jewel => GameLanguageProvider.Language.Classes.Jewel,
                        ItemClass.OneHandAxe => GameLanguageProvider.Language.Classes.OneHandAxes,
                        ItemClass.OneHandMace => GameLanguageProvider.Language.Classes.OneHandMaces,
                        ItemClass.OneHandSword => GameLanguageProvider.Language.Classes.OneHandSwords,
                        ItemClass.Quiver => GameLanguageProvider.Language.Classes.Quivers,
                        ItemClass.Ring => GameLanguageProvider.Language.Classes.Ring,
                        ItemClass.RuneDagger => GameLanguageProvider.Language.Classes.RuneDaggers,
                        ItemClass.Sceptre => GameLanguageProvider.Language.Classes.Sceptres,
                        ItemClass.Shield => GameLanguageProvider.Language.Classes.Shields,
                        ItemClass.Staff => GameLanguageProvider.Language.Classes.Staves,
                        ItemClass.TwoHandAxe => GameLanguageProvider.Language.Classes.TwoHandAxes,
                        ItemClass.TwoHandMace => GameLanguageProvider.Language.Classes.TwoHandMaces,
                        ItemClass.TwoHandSword => GameLanguageProvider.Language.Classes.TwoHandSwords,
                        ItemClass.Wand => GameLanguageProvider.Language.Classes.Wands,
                        ItemClass.Warstaff => GameLanguageProvider.Language.Classes.Warstaves,
                        _ => itemClass.ToString(),
                    },
                    Value = itemClass.ToString(),
                };
            }
        }

        if (Condition.Type == AutoSelectConditionType.StatCategory)
        {
            var results = new List<SelectOption>()
            {
                CreateStatCategory(StatCategory.Implicit),
                CreateStatCategory(StatCategory.Explicit),
                CreateStatCategory(StatCategory.Fractured),
            };

            if (Item.Game == GameType.PathOfExile2)
            {
                results.Add(CreateStatCategory(StatCategory.Desecrated));
                results.Add(CreateStatCategory(StatCategory.Rune));
                results.Add(CreateStatCategory(StatCategory.Skill));
            }

            if (Item.Game == GameType.PathOfExile1)
            {
                results.Add(CreateStatCategory(StatCategory.Crafted));
                results.Add(CreateStatCategory(StatCategory.Mutated));
            }

            return results;

            SelectOption CreateStatCategory(StatCategory statCategory)
            {
                return new SelectOption()
                {
                    Label = StatCategoryResources[statCategory.ToString()],
                    Value = statCategory.ToString(),
                };
            }
        }

        return [];
    }
}
