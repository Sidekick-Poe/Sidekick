@using System.Text.Json
@using Sidekick.Apis.Poe.Items
@using Sidekick.Apis.Poe.Trade.Trade.Filters.AutoSelect
@using Sidekick.Data.Items.Models
@using Sidekick.Data.Languages

@if (Condition.Comparison is AutoSelectComparisonType.True or AutoSelectComparisonType.False)
{
    return;
}

@if (Condition.Comparison is AutoSelectComparisonType.IsContainedIn or AutoSelectComparisonType.IsNotContainedIn)
{
    <div class="grid grid-cols-3 gap-y-0.5 gap-x-3 w-full">
        @foreach (var option in GetOptions())
        {
            <FormCheckbox Value="IsChecked(option)"
                          ValueChanged="(value) => ToggleCheck(option, value)"
                          Readonly="Readonly">
                <span class="line-clamp-1">@option.Label</span>
            </FormCheckbox>
        }
    </div>
    return;
}

<FormInputInline Value="@Condition.Value"
                 ValueChanged="Changed"
                 Readonly="Readonly"/>

@inject ICurrentGameLanguage CurrentGameLanguage
@inject IStringLocalizer<StatCategory> StatCategoryResources

@code {

    [CascadingParameter]
    public required Item Item { get; set; }

    [Parameter]
    public required AutoSelectCondition Condition { get; set; }

    [Parameter]
    public bool Readonly { get; set; }

    [Parameter]
    public EventCallback OnChanged { get; set; }

    public void Update()
    {
        StateHasChanged();
    }

    private async Task Changed(string? value)
    {
        Condition.Value = value;
        await OnChanged.InvokeAsync();
    }

    private bool IsChecked(SelectOption option) => Condition.Value?.Contains($"\"{option.Value ?? "null"}\"") ?? false;

    private async Task ToggleCheck(SelectOption option, bool isChecked)
    {
        List<string> value;
        try
        {
            value = JsonSerializer.Deserialize<List<string>>(Condition.Value ?? "[]", AutoSelectPreferences.JsonSerializerOptions) ?? [];
        }
        catch (Exception)
        {
            value = [];
        }

        if (isChecked)
        {
            value.Add(option.Value ?? "null");
        }
        else
        {
            value.Remove(option.Value ?? "null");
        }

        Condition.Value = JsonSerializer.Serialize(value, AutoSelectPreferences.JsonSerializerOptions);
        await OnChanged.InvokeAsync();
    }

    private List<SelectOption> GetOptions()
    {
        if (Condition.Type == AutoSelectConditionType.Rarity)
        {
            return
            [
                CreateRarity(Rarity.Normal),
                CreateRarity(Rarity.Magic),
                CreateRarity(Rarity.Rare),
                CreateRarity(Rarity.Unique),
                CreateRarity(Rarity.Currency),
            ];

            SelectOption CreateRarity(Rarity rarity)
            {
                return new SelectOption()
                {
                    Label = rarity switch
                    {
                        Rarity.Currency => CurrentGameLanguage.Language.RarityCurrency,
                        Rarity.DivinationCard => CurrentGameLanguage.Language.RarityDivinationCard,
                        Rarity.Normal => CurrentGameLanguage.Language.RarityNormal,
                        Rarity.Magic => CurrentGameLanguage.Language.RarityMagic,
                        Rarity.Rare => CurrentGameLanguage.Language.RarityRare,
                        Rarity.Unique => CurrentGameLanguage.Language.RarityUnique,
                        _ => rarity.ToString(),
                    },
                    Value = rarity.ToString(),
                };
            }
        }

        if (Condition.Type == AutoSelectConditionType.ItemClass)
        {
            return
            [
                CreateItemClass(ItemClass.AbyssJewel),
                CreateItemClass(ItemClass.Amulet),
                CreateItemClass(ItemClass.Belt),
                CreateItemClass(ItemClass.BodyArmour),
                CreateItemClass(ItemClass.Boots),
                CreateItemClass(ItemClass.Bow),
                CreateItemClass(ItemClass.Claw),
                CreateItemClass(ItemClass.Crossbow),
                CreateItemClass(ItemClass.Dagger),
                CreateItemClass(ItemClass.FishingRod),
                CreateItemClass(ItemClass.Flask),
                CreateItemClass(ItemClass.Gloves),
                CreateItemClass(ItemClass.Helmet),
                CreateItemClass(ItemClass.Jewel),
                CreateItemClass(ItemClass.OneHandAxe),
                CreateItemClass(ItemClass.OneHandMace),
                CreateItemClass(ItemClass.OneHandSword),
                CreateItemClass(ItemClass.Quiver),
                CreateItemClass(ItemClass.Ring),
                CreateItemClass(ItemClass.RuneDagger),
                CreateItemClass(ItemClass.Sceptre),
                CreateItemClass(ItemClass.Shield),
                CreateItemClass(ItemClass.Staff),
                CreateItemClass(ItemClass.TwoHandAxe),
                CreateItemClass(ItemClass.TwoHandMace),
                CreateItemClass(ItemClass.TwoHandSword),
                CreateItemClass(ItemClass.Wand),
                CreateItemClass(ItemClass.Warstaff),
            ];

            SelectOption CreateItemClass(ItemClass itemClass)
            {
                return new SelectOption()
                {
                    Label = itemClass switch
                    {
                        ItemClass.AbyssJewel => CurrentGameLanguage.Language.ClassAbyssJewel,
                        ItemClass.Amulet => CurrentGameLanguage.Language.ClassAmulet,
                        ItemClass.Belt => CurrentGameLanguage.Language.ClassBelt,
                        ItemClass.BodyArmour => CurrentGameLanguage.Language.ClassBodyArmours,
                        ItemClass.Boots => CurrentGameLanguage.Language.ClassBoots,
                        ItemClass.Bow => CurrentGameLanguage.Language.ClassBows,
                        ItemClass.Claw => CurrentGameLanguage.Language.ClassClaws,
                        ItemClass.Crossbow => CurrentGameLanguage.Language.ClassCrossbows,
                        ItemClass.Dagger => CurrentGameLanguage.Language.ClassDaggers,
                        ItemClass.FishingRod => CurrentGameLanguage.Language.ClassFishingRods,
                        ItemClass.Flask => CurrentGameLanguage.Language.ClassUtilityFlasks,
                        ItemClass.Gloves => CurrentGameLanguage.Language.ClassGloves,
                        ItemClass.Helmet => CurrentGameLanguage.Language.ClassHelmets,
                        ItemClass.Jewel => CurrentGameLanguage.Language.ClassJewel,
                        ItemClass.OneHandAxe => CurrentGameLanguage.Language.ClassOneHandAxes,
                        ItemClass.OneHandMace => CurrentGameLanguage.Language.ClassOneHandMaces,
                        ItemClass.OneHandSword => CurrentGameLanguage.Language.ClassOneHandSwords,
                        ItemClass.Quiver => CurrentGameLanguage.Language.ClassQuivers,
                        ItemClass.Ring => CurrentGameLanguage.Language.ClassRing,
                        ItemClass.RuneDagger => CurrentGameLanguage.Language.ClassRuneDaggers,
                        ItemClass.Sceptre => CurrentGameLanguage.Language.ClassSceptres,
                        ItemClass.Shield => CurrentGameLanguage.Language.ClassShields,
                        ItemClass.Staff => CurrentGameLanguage.Language.ClassStaves,
                        ItemClass.TwoHandAxe => CurrentGameLanguage.Language.ClassTwoHandAxes,
                        ItemClass.TwoHandMace => CurrentGameLanguage.Language.ClassTwoHandMaces,
                        ItemClass.TwoHandSword => CurrentGameLanguage.Language.ClassTwoHandSwords,
                        ItemClass.Wand => CurrentGameLanguage.Language.ClassWands,
                        ItemClass.Warstaff => CurrentGameLanguage.Language.ClassWarstaves,
                        _ => itemClass.ToString(),
                    },
                    Value = itemClass.ToString(),
                };
            }
        }

        if (Condition.Type == AutoSelectConditionType.StatCategory)
        {
            var results = new List<SelectOption>()
            {
                CreateStatCategory(StatCategory.Implicit),
                CreateStatCategory(StatCategory.Explicit),
                CreateStatCategory(StatCategory.Fractured),
            };

            if (Item.Game == GameType.PathOfExile2)
            {
                results.Add(CreateStatCategory(StatCategory.Desecrated));
                results.Add(CreateStatCategory(StatCategory.Rune));
                results.Add(CreateStatCategory(StatCategory.Skill));
            }

            if (Item.Game == GameType.PathOfExile1)
            {
                results.Add(CreateStatCategory(StatCategory.Crafted));
                results.Add(CreateStatCategory(StatCategory.Mutated));
            }

            return results;

            SelectOption CreateStatCategory(StatCategory statCategory)
            {
                return new SelectOption()
                {
                    Label = StatCategoryResources[statCategory.ToString()],
                    Value = statCategory.ToString(),
                };
            }
        }

        return [];
    }
}
